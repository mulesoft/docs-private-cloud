= To Install Anypoint Private Cloud using the Command Line Installer
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

This topic describes how to install Anypoint Platform Private Cloud Edition using a CLI-based installer. This  installer enables you to specify all required parameters from the command line.

[WARNING]
====
Before running the installer, ensure that your system meets the minimum system requirements.
====

== Prerequisites

To run the CLI-based installer, ensure that you have root access on all of the servers in your environment.
// https://m.wikihow.com/Become-Root-in-Linux???? Include info like this??

Before running the installer, you need the following:

* The IP address of each server in your installation.
* The Docker device on each server
* Your Anypoint Platform Private Cloud Edition license file
* Anypoint Private Cloud requires that you have an NFS server installed and configured. Ensure that this is installed before beginning. See xref:prereq-workflow.adoc[Private Cloud Edition Verify Prerequisites].

== About the Installation Scripts

The automated installation uses two scripts:

* `gravity install`: begins the installation and handles intra-server communication during the install. This script also installs the platform on the server.
* `gravity join`: installs the platform on each additional server.

The script you run on each node of your installation and the values of the `role` parameter depend on the type of installation you are performing:

[%header,cols="4*a"]
|===
|If you are installing a ... |Run ... |Value of the `flavor` parameter |Value of the `role` parameter
|1-node configuration |`gravity install` on 1 node |`flavor=one` |`role=demo_node`
|3-node configuration |`gravity install` on 1 node |`flavor=three` |`role=general_node`
| |`gravity join` on the 2 remaining nodes |N/A |`role=general_node`
|6-node configuration |`gravity install` on 1 node |`flavor=six` |`role=app_node`
| |`gravity join` on 2 nodes |N/A |`role=app_node`
| |`gravity join` on the 3 remaining nodes |N/A |`role=data_node`
|===

When installing a single-node configuration, the automated installer also installs and configures the demo LDAP server.

== Run the Command Line Installation

// Link to minimum sys requirements???

. Obtain the `anypoint-2.0.0-installer.tar.gz` archive from your customer success representative.
. Copy the archive to each server node in your cluster.
// Inconsistent terminolgy - can we use just 'server' or just 'node'? (This assumes 'server' = 'node'.)??? How do I copy the archive to other nodes???
. Uncompress the gzip archive:
// How can I get the name of the cluster? How do I get the Secret token and IP address for each server? How do I get the Docker device on each server???? Input from partner: "The CLI install script requests a Secret Token and states "Specifies a secure token used for intra-server communication during the installation. This token must be generated by the same user running the installer."  But generated by what and how.  This too is absent from the documentation."
+
----
tar xvf anypoint-2.0.0-installer.tar.gz
----

. Run the following command on one of the nodes in your cluster:
// Does PCE use the same license as MuleSoft Runtime? (Assumption is yes.)
+
----
sudo ./gravity install --advertise-addr=<installer_IP> --token=<secret token> --cluster=<cluster name> --cloud-provider=generic --flavor=<flavor name> --license="$(cat license.pem)" --docker-device=<device> --role=<role>
----
+
Using the following values:
+
[%header,cols="2*a"]
|===
|Parameter | Description
|installer_IP | Specifies the IP address used to access the node.
|secret_token | Specifies a secure token used for intra-server communication during the installation. This token must be generated by the same user running the installer.
|cluster_name | Defines the name of your cluster.
|flavor | Specifies the number of nodes in your cluster. Valid values are: `one`, `three`, and `six`.
|device | Specifies the the path to the Docker device on each server. Use `lsblk` to list the available devices.
|role | Specifies the role of the server where you are running the command. Valid values are: `general_node`, `data_node` and `app_node`.
|===

. If you are performing a multi-node installation, run the following command while the `./gravity install` command is running. If you are performing a single-node installation, skip this step:
// I've seen feedback that says single node install doesn't work. Should this be removed???
+
Use the same values you provided in the previous command.
+
----
sudo ./gravity join <installer_IP> --advertise-addr=<node_IP> --token=<secret_token> --docker-device=<device> --role=<role> --cloud-provider=generic
----
+
This command causes each of the nodes to join the cluster created by the `./gravity install` command.
+
[WARNING]
If you are running the above command using `ssh` ensure the session does not time out during installation or the installer fails.
Using `nohup` and `&` at the end, e.g. `sudo nohup ./gravity ...rest of command... &` will causes the process to start in the background and continue running if your SSH session expires.
Using `screen` or `tmux` is another alternative to keep a process running if your ssh-session ends.
+
Wait for the `./gravity install` and `./gravity join` commands to complete. This may take some time.

. From the node where you ran `./gravity install`, enter the gravity shell:
+
----
sudo gravity enter
----

. Create the Ops Center and the Anypoint Platform users by running the following command in the gravity shell
+
[NOTE]
Before running this script, replace the `email`, `name`, and `password` parameters with the corresponding values for your environment. These are the credentials that a system administrator uses to manage the system.
// How do I get the APCE license file? Admin email, name, password, NFS_SERVER_HOST, NFS_SERVER_PATH, PLATFORM_DNS all needed - how do I get these???
+
----
curl -X POST http://bandwagon-mulesoft.default.svc.cluster.local/api/complete -H "Content-Type:application/json" -d '{"organization": "Test Org", "email": "username@mulesoft.com", "name": "username", "password": "my_password", "support": false, "nfsServer": "NFS_SERVER_HOST", "nfsPath": "NFS_SERVER_PATH", "platformDns": "PLATFORM_DNS"}'
----


== See Also

* xref:prereq-workflow.adoc[Workflow: Verify Prerequisites]
* xref:install-installer.adoc[To Install using the GUI-based installer]
* xref:demo-ldap-server.adoc[About the Demo LDAP Server]
