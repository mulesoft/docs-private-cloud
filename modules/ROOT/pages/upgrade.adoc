= Upgrading Anypoint Platform PCE v3.2.3 to v4.0.0
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

[NOTE]
If your Anypoint Platform PCE version is earlier than version 3.2.3, you must first upgrade to version 3.2.3 and then upgrade to version 4.0. 

Upgrading Anypoint Platform Private Cloud Edition version 3.2.3 to version 4.0, consist of the following process:

. Verify your infrastructure environment. +
Before you upgrade to version 4.0, your infrastructure team must verify that your working installation meets any additional requirements described in xref:install-checklist.adoc[Anypoint PCE Prerequisites].
. Contact MuleSoft Professional Services. +
After you verify your infrastructure is correctly set up, contact MuleSoft Professional Services to assist you with upgrading Anypoint Platform PCE.
. Update your DNS.
. Create a backup of Anypoint Platform PCE v3.2.3.
. Install Anypoint Platform PCE v4.0.
. Perform a system restore.
. Perform post-upgrade configurations.

[[update-dns]]
== Update your DNS
As an Anypoint Platform PCE user, you can access Anypoint Platform UI via DNS or directly via a load balancer.

If you access via DNS, follow the steps to xref:upgrade.adoc#create-backup[create a backup].

If you access via a load balancer, update your DNS following these steps: 

. In Amazon Route53, create a new record to update the load balancer to point to a DNS, an example DNS for PCE 3.x is `pce3.mulesoft.com`. 
. Access Anypoint Platform and select *Access Management*.
. Select *DNS/IP*.
. For *Platform DNS/IP*, enter the DNS address where you are hosting the platform.
+
image::pce4-access-management.png["Platform DNS/IP field to enter DNS address in Access Management UI"]
+
[start=5]
. Click *Save*.
. Access Anypoint Platform PCE UI via DNS to ensure the login is successful. 
. In your Anypoint Platform PCE v3.2.3 cluster, scale down `nginx-wss-service`` to 0 replicas. After 5 minutes, scale it back to 3 replicas.

[[create-backup]]
== Create a Backup
To create a backup for upgrading Anypoint Platform PCE 3.2.3 to 4.0, follow these steps:

. Run the following command to patch the Anypoint Platform PCE 3.2.4 cluster ConfigMap to include ignored secrets and buckets: 
+
`kubectl apply -f backup-restore-config(1).yaml`
+
[start=2]
. Generate a backup using `gravity backup`: 
+
`gravity backup /var/lib/gravity/planet/share/backup-3x-dd-mm-yy.tar.gz`
+
. Copy all the files from the NFS server of your Anypoint Platform PCE v3.2.3 cluster over to the NFS server of your Anypoint Platform PCE v4.0 cluster.

. Run the following commands to copy the gravity backup file to the Anypoint Platform PCE v4.0 NFS server:
+
----
mkdir nfs_mount_folder 
mount ${nfsServer}/${nfsPath} nfs_mount_folder
cp backup-3x-dd-mm-yy.tar.gz nfs_mount_folder/
----
+
Ensure the backup is copied to the NFS server so you can then perform a system restore.

== Install Anypoint Platform PCE v4.0
After you complete the backup, the MuleSoft Professional Services team will assist you and provide you the steps to xref:install-workflow.adoc[install Anypoint Platform PCE v4.0].

[NOTE]
After the installation is complete donâ€™t add data or new Mule apps in your Anypoint Platform PCE v4.0 environment.

== Perform a System Restore
To complete the upgrade, you must perform a system restore by following these steps:

. Temporarily set `skip-version-check` to `true` in your Anypoint Platform PCE v4.0 environment:
.. Edit the ConfigMap by running `kubectl edit cm backup-restore-config`
.. Set `skip-version-check` to `true`.

. Perform the restore to v4.0 using the API:
+
----
curl -k https://${platformDns}/platform/restore \
-X POST \ -H "Authorization: Bearer $token" \
-H "Content-Type:application/json" \
-d "{\"nfs-server\": \"${nfsServer}\", \
\"nfs-path\": \"${nfsPath}\", \
\"backup-file-name\": \"backup-3x-dd-mm-yy.tar.gz\" }"
----
+
Ensure the restore is successful by checking the restore logs. All the services and pods should be up and running successfully. 

[start=3]
. After the restore is complete from Anypoint Platform PCE v3.2.3 to v4.0 change back `skip-version-check` to `false`:
.. Edit the ConfigMap by running `kubectl edit cm backup-restore-config`
.. Set `skip-version-check` to `false`. +
This ensures that there will be no blockling to a possible backup and restore process in the future. 

[start=4]
. On the new Anypoint Platform PCE v4.0 environment, update the xref:upgrade.adoc#update-dns[previously created DNS] to point to the v4.0 load balancer in AWS route-53.

. On the new Anypoint Platform PCE v4.0 cluster, update the DNS configuration in *Access Management* through the API (`pce3.mulesoft.com`):
+
----
curl --location --request PUT 'https://swethas4a-600577b350bc4163.elb.us-west-2.amazonaws.com/platform/configuration/dns' \
--header 'Authorization: Bearer token' \
--header 'Content-Type: application/json' \
--data-raw '{"platform-dns":"test.upgrade1.pce.mulesoft.com"}'
----
+
[start=6]
. In your Anypoint Platform PCE v3.2.3 cluster, scale down `nginx-wss-service` to 0 replicas. 
. Ensure the login to Anypoint Platform PCE v4.0 works with the updated DNS.

== Perform Post-Upgrade Configurations

After you complete the upgrade, you can perform the following configurations:

. Add any custom DNS certificate that needs updating.
. Update your Mule Agent to the compatible version 2.6.7 and higher. For details, see xref:runtime-manager::installing-and-configuring-runtime-manager-agent#update-the-agent[Install or Update the Runtime Manager Agent].

All connected Mule apps are automatically reconnected after a few minutes.

== See Also

* xref:install-workflow.adoc[]
* xref:install-checklist.adoc[]
